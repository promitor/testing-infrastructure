name: Deploy to Azure
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
    - 'deploy/**'
    - '.github/workflows/deploy-to-azure.yml'

jobs:
  deploy_to_us:
      name: Deploy to US
      env:
        AZURE_RESOURCEGROUP_NAME: "promitor-testing-infrastructure-us"
      environment:
        name: Promitor US
      runs-on: ubuntu-latest
      steps:
        # Checkout code
      - uses: actions/checkout@main
        name: Checkout code

          # Login to Azure
      - uses: azure/login@v1
        name: Login to Azure
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

        # Deploy Bicep file
      - name: Deploy to Azure
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: ${{ env.AZURE_RESOURCEGROUP_NAME }}
          template: ./deploy/us.bicep
          deploymentName: us-run-${{ github.run_number }}
          deploymentMode: Complete
          failOnStdErr: false

  deploy_to_europe:
      name: Deploy to Europe
      env:
        AZURE_RESOURCEGROUP_NAME: "promitor-testing-infrastructure-europe"
      environment:
        name: Promitor Europe
      runs-on: ubuntu-latest
      steps:
        # Checkout code
      - uses: actions/checkout@main
        name: Checkout code

          # Login to Azure
      - uses: azure/login@v1
        name: Login to Azure
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

        # Deploy Bicep file
      - name: Deploy to Azure
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: ${{ env.AZURE_RESOURCEGROUP_NAME }}
          parameters: sqlServerPassword=${{ secrets.SQL_PASSWORD }}
          template: ./deploy/europe.bicep
          deploymentName: europe-run-${{ github.run_number }}
          deploymentMode: Complete
          failOnStdErr: false

  deploy_large_scale:
      name: Deploy to Large Scale
      env:
        AZURE_RESOURCEGROUP_NAME: "promitor-testing-infrastructure-large-scale"
      environment:
        name: Promitor Large Scale
      runs-on: ubuntu-latest
      steps:
        # Checkout code
      - uses: actions/checkout@main
        name: Checkout code

          # Login to Azure
      - uses: azure/login@v1
        name: Login to Azure
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

        # Deploy Bicep file for Americas
      - name: Deploy to Azure (Americas)
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: ${{ env.AZURE_RESOURCEGROUP_NAME }}
          template: ./deploy/large-scale/large-scale-americas.bicep
          deploymentName: large-scale-americas-run-${{ github.run_number }}
          deploymentMode: Complete
          failOnStdErr: false

        # Deploy Bicep file for APAC
      - name: Deploy to Azure (APAC)
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: ${{ env.AZURE_RESOURCEGROUP_NAME }}
          template: ./deploy/large-scale/large-scale-apac.bicep
          deploymentName: large-scale-apac-run-${{ github.run_number }}
          deploymentMode: Complete
          failOnStdErr: false

        # Deploy Bicep file for Europe
      - name: Deploy to Azure (Europe)
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
          resourceGroupName: ${{ env.AZURE_RESOURCEGROUP_NAME }}
          template: ./deploy/large-scale/large-scale-europe.bicep
          deploymentName: large-scale-europe-run-${{ github.run_number }}
          deploymentMode: Complete
          failOnStdErr: false